<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Study Notes</title>
  <meta name="description" content="Power electronics ? Control ? Embedded ? Notes, experiments, and mini-papers." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Markdown parser (for .md posts) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root{
      --bg:#0b0d10;--panel:#0f1318;--text:#e7edf6;--muted:#9fb0c8;
      --prime:#3ea6ff;--accent:#6ee7b7;--card:#121820;
      --border:rgba(255,255,255,.08);--shadow:0 10px 30px rgba(0,0,0,.3);--radius:16px;
    }
    :root.light{
      --bg:#f6f7fb;--panel:#fff;--text:#0e1622;--muted:#4b5563;
      --prime:#2563eb;--accent:#059669;--card:#fff;
      --border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.07);
    }
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:
        radial-gradient(1200px 1200px at 120% -20%, rgba(62,166,255,.14), transparent 60%),
        radial-gradient(900px 900px at -10% -10%, rgba(110,231,183,.12), transparent 60%),
        var(--bg);
      color:var(--text);line-height:1.6;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 80px}
    header.top{
      display:flex;align-items:center;gap:14px;justify-content:space-between;
      position:sticky;top:0;backdrop-filter:blur(6px);
      background:color-mix(in srgb, var(--bg) 80%, transparent);
      z-index:10;border-bottom:1px solid var(--border);
      padding:14px 18px;margin:-28px -18px 24px;
    }
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--prime),var(--accent));
      box-shadow:var(--shadow);display:grid;place-items:center;font-weight:800;color:white}
    .brand h1{font-size:16px;margin:0;letter-spacing:.3px}
    nav a{color:var(--muted);text-decoration:none;font-weight:600;margin-left:18px}
    nav a:hover{color:var(--text)}
    .btn{border:1px solid var(--border);
      background:linear-gradient(180deg, color-mix(in srgb, var(--panel) 90%, #fff 10%), var(--panel));
      padding:10px 14px;border-radius:12px;color:var(--text);font-weight:600;cursor:pointer}
    .btn:hover{transform:translateY(-1px)}
    .ghost{background:transparent}

    .hero{display:grid;grid-template-columns:1.3fr 1fr;gap:22px;align-items:center;margin:8px 0 22px}
    .hero .card{padding:26px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .hero h2{font-size:28px;line-height:1.25;margin:0 0 10px}
    .hero p{margin:0;color:var(--muted)}

    .tools{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
    .tools .chip{border:1px solid var(--border);padding:8px 12px;border-radius:999px;color:var(--muted);font-weight:600}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:18px 0}
    .search{flex:1;display:flex;align-items:center;gap:10px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 12px}
    .search input{flex:1;background:transparent;border:0;color:var(--text);outline:0;font-size:14px}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;color:var(--muted);font-weight:600}
    .tag.active{background:color-mix(in srgb, var(--prime) 18%, transparent);color:var(--text);border-color:color-mix(in srgb, var(--prime) 40%, var(--border))}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media (max-width:980px){.hero{grid-template-columns:1fr}.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}

    .post{display:flex;flex-direction:column}
    .thumb{height:150px;border-bottom:1px solid var(--border);background:
      radial-gradient(500px 120px at 70% -10%, rgba(62,166,255,.18), transparent),
      radial-gradient(360px 180px at -20% 120%, rgba(110,231,183,.18), transparent),
      linear-gradient(135deg,#0f172a,#0b1220)}
    .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px;padding:12px 16px 0}
    .post h3{font-size:18px;margin:8px 16px 8px}
    .post p{margin:0 16px 16px;color:var(--muted)}
    .badge{padding:6px 9px;border-radius:999px;background:color-mix(in srgb, var(--accent) 18%, transparent);color:var(--text);border:1px solid var(--border);font-size:11px;font-weight:700;letter-spacing:.3px}

    .footer{margin-top:28px;display:flex;justify-content:space-between;align-items:center;color:var(--muted)}
    .small{font-size:12px}
    .hidden{display:none}
  </style>
</head>

<body>
  <div class="wrap">
    <header class="top">
      <div class="brand">
        <div class="logo">AE</div>
        <h1>Portfolio</h1>
      </div>
      <nav>
        <a href="#" data-route="home">Home</a>
        <a href="#" data-route="about">About</a>
        <a href="#" data-route="tags">Tags</a>
        <button id="darkToggle" class="btn ghost" title="Toggle theme">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="15" height="15">
            <path d="M32 2 A30 30 0 0 0 32 62 Z" fill="#3b3b3b"/>
            <path d="M32 2 A30 30 0 0 1 32 62 Z" fill="#facc15"/>
            <circle cx="32" cy="32" r="30" fill="none" stroke="#111" stroke-width="2"/>
          </svg>
        </button>
        <a class="btn" href="https://github.com/yourname" target="_blank" rel="noreferrer">GitHub</a>
      </nav>
    </header>

    <section id="homeView">
      <div class="hero">
        <div class="card">
          <h2>Power Electronics, Control, and Embedded explained with clean demos, PSIM models, and short, readable write-ups.</h2>
          <p>Each post is a mini-paper: what I tested, how I tested it, results, and what I learned and more.</p>
          <div class="tools">
            <span class="chip">Coming soon</span>
            <span class="chip">Coming soon</span>
            <span class="chip">Coming soon</span>
          </div>
        </div>
        <div class="card">
          <div class="controls">
            <div class="search">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21L15.8 15.8M10.5 18C14.1 18 17 15.1 17 11.5C17 7.9 14.1 5 10.5 5C6.9 5 4 7.9 4 11.5C4 15.1 6.9 18 10.5 18Z" stroke="currentColor" stroke-width="1.5"/></svg>
              <input id="q" placeholder="Search posts, e.g. droop, PWM, PI tuning" aria-label="Search posts" />
            </div>
            <div class="tags" id="tagBar"></div>
          </div>
          <div class="small" style="color:var(--muted);padding:0 4px 6px">Tip: press <strong>/</strong> to focus search.</div>
        </div>
      </div>

      <div class="grid" id="postGrid"></div>

      <div class="footer">
        <div class="small">Â© <span id="year"></span> Altanbaatar Enkhsuld. Built with HTML + vanilla JS. Deployed on GitHub Pages.</div>
        <div class="small"><a style="color:var(--muted)" href="#" data-route="about">About this site</a></div>
      </div>
    </section>

    <section id="articleView" class="hidden"></section>
    <section id="aboutView" class="hidden"></section>
    <section id="tagsView" class="hidden"></section>
  </div>

  <!-- App script (loads /posts/index.json, renders pages, handles routing/search/tags) -->
  <script>
    let POSTS = [];
    let state = { q:'', tag:null, route:'home', articleId:null };

    const $  = s => document.querySelector(s);
    const $all = s => Array.from(document.querySelectorAll(s));
    const uniq = a => Array.from(new Set(a));

    async function loadIndex(){
      const res = await fetch('/posts/index.json', { cache:'no-store' });
      POSTS = await res.json();
      POSTS.sort((a,b) => a.date < b.date ? 1 : -1); // newest first
    }

    function matchesSearch(p,q){
      if(!q) return true;
      return (p.title + ' ' + p.summary + ' ' + p.tags.join(' ')).toLowerCase().includes(q.toLowerCase());
    }
    function matchesTag(p,t){ return !t || p.tags.includes(t); }

    function renderPosts(){
      const grid = $('#postGrid');
      const list = POSTS.filter(p=>matchesSearch(p,state.q)).filter(p=>matchesTag(p,state.tag));
      if(!list.length){
        grid.innerHTML = '<div class="card" style="padding:22px">No posts found.</div>';
        return;
      }
      grid.innerHTML = list.map(p=>{
        const tags = p.tags.map(t=>`<span class="badge">${t}</span>`).join(' ');
        return `<article class="post" data-id="${p.id}">
          <div class="thumb"></div>
          <div class="meta small">${p.date} ? ${p.minutes} min ? ${tags}</div>
          <h3>${p.title}</h3>
          <p>${p.summary}</p>
        </article>`;
      }).join('');
      $all('.post').forEach(card=>card.addEventListener('click',()=>go('article', card.dataset.id)));
    }

    async function renderArticle(id){
      const p = POSTS.find(x=>x.id===id); if(!p) return;

      // Load Markdown if needed
      let bodyHtml = '';
      if ((p.type || '').includes('md')) {
        const res = await fetch(p.content, { cache:'no-store' });
        const md = await res.text();
        bodyHtml = marked.parse(md);
      } else {
        bodyHtml = `<p>${p.summary || ''}</p>`;
      }

      // Optional embedded PDF if pdfUrl is provided (works for md-only, pdf-only, or md+pdf)
      const pdfBlock = p.pdfUrl ? `
        <div class="card" style="padding:0;margin-top:18px;overflow:hidden">
          <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <div class="small" style="color:var(--muted)">PDF preview</div>
            <a class="btn" href="${p.pdfUrl}" target="_blank" rel="noopener">Open PDF ?</a>
          </div>
          <object data="${p.pdfUrl}" type="application/pdf" width="100%" height="720">
            <iframe src="${p.pdfUrl}" width="100%" height="720"></iframe>
          </object>
        </div>` : '';

      const tags = p.tags.map(t=>`<span class="badge">${t}</span>`).join(' ');
      $('#articleView').innerHTML = `
        <div class="card" style="padding:26px">
          <div class="meta small" style="color:var(--muted)">${p.date} ? ${p.minutes} min ? ${tags}</div>
          <h1 style="margin-top:8px">${p.title}</h1>
          ${bodyHtml}
          ${pdfBlock}
          <div style="margin-top:24px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn" onclick="go('home')">
            <svg width="14" height="14" viewBox="0 0 24 24" style="vertical-align:-2px; margin-right:6px">
                <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back
            </button>
            ${p.tags.map(t=>`<button class="btn" onclick="filterByTag('${t}')">#${t}</button>`).join('')}
          </div>
        </div>`;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function renderAbout(){
      $('#aboutView').innerHTML = `
        <div class="card" style="padding:26px">
          <h1>About This Site</h1>
          <p class="small" style="color:var(--muted)">
            Power electronics / control / embedded notes. Each post is a small, reproducible experiment or explanation with practical results.
          </p>
          <ul>
            <li>Markdown posts for quick write-ups</li>
            <li>PDF posts for detailed lab reports</li>
            <li>Search + tags for fast navigation</li>
          </ul>
          <button class="btn" onclick="go('home')">
            <svg width="14" height="14" viewBox="0 0 24 24" style="vertical-align:-2px; margin-right:6px">
                <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back
            </button>
        </div>`;
    }

    function renderTags(){
      const all = uniq(POSTS.flatMap(p=>p.tags)).sort();
      const counts = Object.fromEntries(all.map(t => [t, POSTS.filter(p=>p.tags.includes(t)).length]));
      $('#tagsView').innerHTML = `
        <div class="card" style="padding:20px">
          <h1>Tags</h1>
          <div class="tags" style="margin-top:10px">
            ${all.map(t=>`
              <button class="tag ${state.tag===t?'active':''}" onclick="filterByTag('${t}')">
                #${t} <span class="small" style="opacity:.7">(${counts[t]})</span>
              </button>`).join('')}
          </div>
          <div style="margin-top:18px">
            <button class="btn" onclick="clearTag()">Clear</button>
            <button class="btn" onclick="go('home')">
            <svg width="14" height="14" viewBox="0 0 24 24" style="vertical-align:-2px; margin-right:6px">
                <path d="M15 18l-6-6 6-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Back
            </button>
          </div>
        </div>`;
    }

    function show(viewId){
      ['homeView','articleView','aboutView','tagsView'].forEach(id=>{
        document.getElementById(id).classList.toggle('hidden', id !== viewId);
      });
    }

    function buildTagBar(){
      const bar = $('#tagBar');
      const all = uniq(POSTS.flatMap(p=>p.tags)).sort();
      bar.innerHTML = all.map(t=>`<button class="tag ${state.tag===t?'active':''}" data-tag="${t}">#${t}</button>`).join('');
      $all('#tagBar .tag').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const t = btn.getAttribute('data-tag');
          state.tag = (state.tag===t) ? null : t;
          buildTagBar(); renderPosts(); updateHash();
        });
      });
    }

    function wireSearch(){
      const input = $('#q'); input.value = state.q;
      input.addEventListener('input', ()=>{
        state.q = input.value.trim();
        renderPosts(); updateHash();
      });
      // "/" to focus
      window.addEventListener('keydown', (e)=>{
        if(e.key==='/' && document.activeElement!==input){
          e.preventDefault(); input.focus();
        }
      });
    }

    // --- Routing (hash) ---
    function parseHash(){
      const [path, query] = location.hash.slice(1).split('?');
      const params = new URLSearchParams(query || '');
      const parts = (path || '/home').split('/').filter(Boolean);
      state.q = params.get('q') || '';
      state.tag = params.get('tag') || null;

      if(parts[0]==='home'){ state.route='home'; state.articleId=null; }
      else if(parts[0]==='about'){ state.route='about'; state.articleId=null; }
      else if(parts[0]==='tags'){ state.route='tags'; state.articleId=null; }
      else if(parts[0]==='post' && parts[1]){ state.route='article'; state.articleId=parts[1]; }
      else { state.route='home'; state.articleId=null; }
    }
    function updateHash(){
      const qs = new URLSearchParams();
      if(state.q) qs.set('q', state.q);
      if(state.tag) qs.set('tag', state.tag);
      const base = '#/' + (state.route==='article' ? `post/${state.articleId}` : state.route);
      const s = qs.toString();
      location.hash = s ? `${base}?${s}` : base;
    }
    function go(route, payload){
      state.route = route;
      if(route==='article') state.articleId = payload;
      updateHash(); renderNow();
    }
    function filterByTag(t){ state.tag = t; updateHash(); renderNow(); }
    function clearTag(){ state.tag = null; updateHash(); renderNow(); }

    async function renderNow(){
      // wire nav each time (simple)
      $all('[data-route]').forEach(a=>{
        a.onclick = (e)=>{ e.preventDefault(); go(a.dataset.route); };
      });

      buildTagBar();
      wireSearch();

      if(state.route==='home'){ renderPosts(); show('homeView'); }
      else if(state.route==='article' && state.articleId){ await renderArticle(state.articleId); show('articleView'); }
      else if(state.route==='about'){ renderAbout(); show('aboutView'); }
      else if(state.route==='tags'){ renderTags(); show('tagsView'); }
      else { renderPosts(); show('homeView'); }
    }

    window.addEventListener('hashchange', ()=>{ parseHash(); renderNow(); });

    // Boot
    (async function init(){
      await loadIndex();
      parseHash();
      renderNow();
    })();
  </script>

  <!-- Theme script (same as before) -->
  <script>
    const root = document.documentElement;
    const KEY='ae-theme';
    function applyTheme(t){ root.classList.toggle('light', t==='light'); }
    function getTheme(){ return localStorage.getItem(KEY) || (matchMedia('(prefers-color-scheme: light)').matches?'light':'dark'); }
    document.getElementById('darkToggle').onclick = ()=>{
      const t = getTheme()==='light' ? 'dark' : 'light';
      localStorage.setItem(KEY, t); applyTheme(t);
    };
    applyTheme(getTheme());
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
